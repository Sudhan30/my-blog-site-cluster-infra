apiVersion: v1
kind: ConfigMap
metadata:
  name: dagster-instance
  namespace: trading
  labels:
    app: dagster
    app.kubernetes.io/part-of: algo-trading-system
data:
  dagster.yaml: |
    scheduler:
      module: dagster.core.scheduler
      class: DagsterDaemonScheduler

    run_coordinator:
      module: dagster.core.run_coordinator
      class: QueuedRunCoordinator

    run_launcher:
      module: dagster_k8s
      class: K8sRunLauncher
      config:
        # REQUIRED: ConfigMap name containing this instance configuration
        instance_config_map: dagster-instance

        # Kubernetes namespace where job pods will be launched
        job_namespace: trading

        # Service account for job pods
        service_account_name: dagster

        # Docker image for run pods (must match deployment image tag)
        job_image: docker.io/sudhan03/algo-trading:portfolio-tracker-30ca58d
        image_pull_policy: Always

        # Image pull secrets for private registry access
        image_pull_secrets:
          - name: docker-hub-creds

        # Load K8s config from within cluster
        load_incluster_config: true

        # Environment from ConfigMaps
        env_config_maps:
          - trading-config

        # Environment from Secrets
        env_secrets:
          - trading-secrets

        # Mount shared volume for compute logs (same as deployment)
        volumes:
          - name: dagster-logs
            persistentVolumeClaim:
              claimName: dagster-logs-pvc

        volume_mounts:
          - name: dagster-logs
            mount_path: /opt/dagster/logs

        # Delete completed run pods immediately (logs are stored in PVC)
        job_spec_config:
          ttl_seconds_after_finished: 0

    storage:
      postgres:
        postgres_db:
          hostname: timescaledb
          username:
            env: DB_USER
          password:
            env: DB_PASSWORD
          db_name: trading_db
          port: 5432

    # Persistent compute log storage using shared PVC
    compute_logs:
      module: dagster.core.storage.local_compute_log_manager
      class: LocalComputeLogManager
      config:
        base_dir: /opt/dagster/logs

    # Automatic retention policies (handled by Dagster daemon)
    retention:
      schedule:
        purge_after_days: 90  # Delete runs older than 90 days
      sensor:
        purge_after_days: 90
      auto_materialize:
        purge_after_days: 90
