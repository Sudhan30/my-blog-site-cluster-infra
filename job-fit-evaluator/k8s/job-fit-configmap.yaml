apiVersion: v1
kind: ConfigMap
metadata:
  name: job-fit-backend-code
  namespace: web
data:
  main.py: |
    from fastapi import FastAPI, HTTPException
    from pydantic import BaseModel
    import requests
    import hashlib
    import json
    from fastapi.middleware.cors import CORSMiddleware
    import os

    app = FastAPI()

    # Enable CORS for the frontend
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    CACHE = {}
    OLLAMA_HOST = os.getenv("OLLAMA_HOST", "http://ollama-service:11434")

    class FitRequest(BaseModel):
        resume: str = None
        preferences: dict = None
        job: str

    def cache_key(data: FitRequest):
        resume_part = data.resume[:50] if data.resume else "no-resume" 
        job_part = data.job[:50] 
        raw = resume_part + json.dumps(data.preferences or {}) + data.job
        return hashlib.sha256(raw.encode()).hexdigest()

    PROMPT_TEMPLATE = """
    You are a job fit evaluator for a professional portfolio website.
    Your task is to evaluate how well the portfolio owner fits a job.

    Be objective and evidence based.
    Do not assume skills that are not written.
    If data is missing, say unknown.

    Resume:
    {resume}

    Preferences:
    {preferences}

    Job Description:
    {job}

    TASK
    Compare the resume and preferences to the job.
    Evaluate skills match, experience level match, domain match, role and career alignment.

    SCORING
    Give a score from 0 to 100.
    90-100: strong fit
    70-89: good fit
    50-69: partial fit
    <50: weak fit

    OUTPUT
    Return ONLY valid JSON.
    {{
    "fit_score": 0,
    "fit_level": "",
    "aligned_areas": [],
    "gaps": [],
    "summary": "",
    "verdict": ""
    }}

    Keep summary under 80 words.
    """

    @app.post("/job-fit")
    def job_fit(req: FitRequest):
        if not req.resume:
           return {"error": "Resume text is required"}

        key = cache_key(req)
        if key in CACHE:
            print(f"Cache hit for {key}")
            return CACHE[key]

        prompt = PROMPT_TEMPLATE.format(
            resume=req.resume,
            preferences=json.dumps(req.preferences or {}),
            job=req.job
        )

        try:
            print(f"Sending request to Ollama at {OLLAMA_HOST}...")
            r = requests.post(
                f"{OLLAMA_HOST}/api/generate",
                json={
                    "model": "gemma:7b", 
                    "prompt": prompt,
                    "stream": False,
                    "temperature": 0.3,
                    "format": "json"
                },
                timeout=120
            )
            r.raise_for_status()
            text = r.json().get("response", "")
            print("Received response from Ollama")

            try:
                parsed = json.loads(text)
            except json.JSONDecodeError:
                start = text.find("{")
                end = text.rfind("}") + 1
                if start != -1 and end != -1:
                     parsed = json.loads(text[start:end])
                else:
                     parsed = {"error": "invalid_json", "raw": text}

            CACHE[key] = parsed
            return parsed

        except Exception as e:
            print(f"Error: {e}")
            raise HTTPException(status_code=500, detail=str(e))

    @app.get("/health")
    def health():
        return {"status": "ok"}
